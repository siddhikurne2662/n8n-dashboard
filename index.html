<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>n8n Workflow Manager Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">

<style>
  /* Variables and base styles remain the same as your original */
  :root {
    --color-primary: hsl(14, 98%, 56%);
    --color-success: hsl(140, 50%, 45%);
    --color-failure: hsl(350, 70%, 55%);
    --color-background: #F9FAFB;
    --color-surface: #FFFFFF;
    --color-text-dark: #333333;
    --color-text-light: #9AA5B1;
    --shadow-soft: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
    --shadow-hover: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.05);
    --radius-default: 12px;
  }
  body { font-family:'Inter','Roboto',sans-serif; background-color: var(--color-background); color: var(--color-text-dark); margin:0; padding-top:60px; transition:background-color 0.3s; }
  .navbar { position: fixed; top:0; left:0; width:100%; height:60px; background-color: var(--color-surface); box-shadow: var(--shadow-soft); display:flex; align-items:center; justify-content:space-between; padding:0 24px; z-index:1000; }
  .logo-text { font-size:1.5rem; font-weight:700; color:var(--color-primary); }
  .main-content { display:flex; padding:24px; }
  .sidebar { width:250px; padding-right:24px; flex-shrink:0; }
  .workflow-grid { flex-grow:1; display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:24px; }
  .workflow-card { background-color: var(--color-surface); border-radius: var(--radius-default); box-shadow: var(--shadow-soft); padding:20px; transition:all 0.3s ease; display:flex; flex-direction:column; }
  .workflow-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
  .status-pill { display:inline-block; padding:4px 10px; border-radius:9999px; font-size:0.85rem; font-weight:600; margin-left:10px; }
  .status-active { background-color: var(--color-success); color:white; }
  .status-inactive { background-color: var(--color-text-light); color: var(--color-surface); }
  .action-button { background-color:transparent; border:none; color: var(--color-text-dark); cursor:pointer; padding:8px; border-radius:6px; transition: background-color 0.2s; margin-left:8px; }
  .action-button:hover { background-color: rgba(0,0,0,0.05); }
  .btn-primary { background-color: var(--color-primary); color:white; padding:10px 15px; border-radius:8px; font-weight:600; transition: background-color 0.2s; }
  .btn-primary:hover { background-color:hsl(14,85%,50%); }
  .search-input { padding:8px 12px; border:1px solid #ccc; border-radius:8px; font-size:1rem; width:250px; }
  .text-subtle { color: var(--color-text-light); font-size:0.9rem; }

  @media (max-width:768px) { .sidebar{display:none;} .main-content{padding:16px;} .workflow-grid{grid-template-columns:1fr;} .navbar{padding:0 16px;} .search-input{width:100px;} }

  /* Modal styling */
  .modal { position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.4); display:none; justify-content:center; align-items:center; z-index:2000; }
  .modal-content { background-color: var(--color-surface); padding:30px; border-radius: var(--radius-default); box-shadow: var(--shadow-hover); max-width:600px; width:90%; max-height:90vh; overflow-y:auto; }
</style>
</head>
<body>

<header class="navbar">
  <div style="display:flex; align-items:center;">
    <i class="fas fa-cubes" style="color: var(--color-primary); font-size:1.8rem; margin-right:10px;"></i>
    <span class="logo-text">n8n Manager</span>
  </div>
  <nav style="display:flex; gap:20px; font-weight:600;">
    <a href="#" style="color: var(--color-text-dark); text-decoration:none; border-bottom:2px solid var(--color-primary); padding-bottom:4px;">Workflows</a>
    <a href="#" style="color: var(--color-text-light); text-decoration:none; padding-bottom:4px;">Settings</a>
  </nav>
  <div style="display:flex; align-items:center; gap:15px;">
    <input type="search" placeholder="Search workflows..." class="search-input" id="searchInput">
    <button class="action-button"><i class="fas fa-moon"></i></button>
  </div>
</header>

<main class="main-content">
  <aside class="sidebar">
    <h3 style="margin-top:0;">Filters</h3>
    <div style="display:flex; flex-direction:column; gap:8px;">
      <label><input type="checkbox" checked id="filterActive"> Active</label>
      <label><input type="checkbox" checked id="filterInactive"> Inactive</label>
    </div>
  </aside>

  <section style="width:100%;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
      <h1 style="font-size:1.8rem;">Workflows</h1>
      <button class="btn-primary"><i class="fas fa-plus" style="margin-right:5px;"></i> New Workflow</button>
    </div>
    <div class="workflow-grid" id="workflowGrid">
      <p>Loading workflows...</p>
    </div>
  </section>
</main>

<!-- Modals -->
<div id="historyModal" class="modal">
  <div class="modal-content" id="historyContent"></div>
</div>
<div id="confirmModal" class="modal">
  <div class="modal-content" id="confirmContent"></div>
</div>

<script>
const PROXY_URL_BASE = "http://localhost:5678/home/workflows";
let workflows = [];

// NEW: Helper function to correctly call the backend proxy and handle errors
async function callProxyApi(path, method='GET', body = null) {
  const url = PROXY_URL_BASE + path;
  const options = {
    method,
    headers: {
      'Content-Type': 'application/json',
    }
  };

  if (body) {
    options.body = JSON.stringify(body);
  }

  const res = await fetch(url, options);

  if (!res.ok) {
      try {
          const errorData = await res.json();
          throw new Error(errorData.error || `HTTP error! Status: ${res.status}`);
      } catch (e) {
          throw new Error(`HTTP error! Status: ${res.status} when accessing ${url}`);
      }
  }

  // Handle 204 No Content responses
  if (res.status === 204 || res.headers.get('content-length') === '0') {
      return {};
  }

  return res.json();
}


// Loads data from the proxy (GET /api/workflows)
async function loadWorkflows() {
  const grid = document.getElementById('workflowGrid');
  // NOTE: There is no 'Settings' button implemented in the provided code,
  // so the 'Failed to fetch the settings' issue is a design limitation.
  // The 'New Workflow' button also has no function implemented yet.
  grid.innerHTML = '<p>Loading workflows...</p>';
  try {
    const data = await callProxyApi('');
    workflows = data.data || [];
    renderWorkflows();
  } catch (err) {
    grid.innerHTML = `<p style="color:red;">üî¥ Failed to load workflows: ${err.message}</p>`;
    console.error("Error in loadWorkflows:", err);
  }
}

// Renders filtered workflows
function renderWorkflows() {
  const grid = document.getElementById('workflowGrid');
  const searchText = document.getElementById('searchInput').value.toLowerCase();
  const filterActive = document.getElementById('filterActive').checked;
  const filterInactive = document.getElementById('filterInactive').checked;

  const filtered = workflows.filter(w => {
    // Check for null/undefined name property
    const name = w.name || 'Untitled';
    const matchesSearch = name.toLowerCase().includes(searchText);
    const matchesFilter = (filterActive && w.active) || (filterInactive && !w.active);
    return matchesSearch && matchesFilter;
  });

  if(filtered.length === 0) {
    grid.innerHTML = '<p>No workflows found.</p>';
    return;
  }

  // Uses the actual implemented functions below
  grid.innerHTML = filtered.map(w => `
    <div class="workflow-card" id="workflow-${w.id}">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px;">
        <h2 style="font-size:1.2rem; font-weight:600; margin:0;">${w.name || 'Untitled'}</h2>
        <span class="status-pill ${w.active ? 'status-active':'status-inactive'}">${w.active ? 'Active':'Inactive'}</span>
      </div>
      <div style="flex-grow:1;">
        <p class="text-subtle" style="margin:0 0 5px 0;">ID: ${w.id}</p>
        <p class="text-subtle" style="margin:0;">Last Run: ${w.lastRun || 'N/A'}</p>
      </div>
      <div style="display:flex; justify-content:flex-end; padding-top:15px; border-top:1px solid #EEEEEE;">
        <button class="action-button" title="Run Workflow" onclick="runWorkflow('${w.id}')"><i class="fas fa-play"></i></button>
        <button class="action-button" title="${w.active ? 'Deactivate':'Activate'} Workflow" onclick="toggleWorkflow('${w.id}', ${w.active})"><i class="fas fa-power-off" style="color:${w.active?'var(--color-failure)':'var(--color-success)'}"></i></button>
        <button class="action-button" title="View History" onclick="viewHistory('${w.id}')"><i class="fas fa-history"></i></button>
      </div>
    </div>
  `).join('');
}

// **IMPLEMENTED** - Sends POST request to the proxy server to run a workflow
async function runWorkflow(id) {
  try {
    await callProxyApi(`/${id}/run`, 'POST');
    alert('‚úÖ Run successfully triggered for workflow: ' + id);
  } catch (e) {
    alert('‚ùå Failed to trigger run: ' + e.message);
  }
}

// **IMPLEMENTED** - Sends POST request to the proxy server to toggle a workflow
async function toggleWorkflow(id, active) {
  const action = active ? 'deactivate' : 'activate';
  try {
    // Send the *desired* new state to the proxy
    await callProxyApi(`/${id}/toggle`, 'POST', { active: !active });
    alert(`‚úÖ Successfully ${action}d workflow ${id}. Reloading...`);
    loadWorkflows(); // Reload to update status in the view
  } catch (e) {
    alert('‚ùå Failed to toggle workflow: ' + e.message);
  }
}

// **IMPLEMENTED** - Sends GET request to the proxy server to view executions
async function viewHistory(id) {
  const modal = document.getElementById('historyModal');
  const content = document.getElementById('historyContent');
  content.innerHTML = `<h2>Execution History for workflow ${id}</h2><p>Loading...</p>`;
  modal.style.display='flex';

  try {
    const res = await callProxyApi(`/${id}/executions`);
    const list = res.data || res;
    content.innerHTML = `
      <h2>Execution History for workflow ${id}</h2>
      <button onclick="closeModal('historyModal')">Close</button>
      <pre>${JSON.stringify(list, null, 2)}</pre>`;
  } catch (e) {
    content.innerHTML = `
      <h2>‚ùå Error fetching history for workflow ${id}</h2>
      <button onclick="closeModal('historyModal')">Close</button>
      <p style="color:red;">${e.message}</p>`;
  }
}

// Helper function for modals (kept from original)
function closeModal(id) { document.getElementById(id).style.display='none'; }

// Event listeners (kept from original)
document.getElementById('searchInput').addEventListener('input', renderWorkflows);
document.getElementById('filterActive').addEventListener('change', renderWorkflows);
document.getElementById('filterInactive').addEventListener('change', renderWorkflows);
document.querySelector('.btn-primary').addEventListener('click', () => {
    alert('Functionality to create a New Workflow is not yet implemented.');
});
// The 'Settings' link has no function and will show a generic error if clicked.
document.querySelector('nav a[href="#"]:nth-child(2)').addEventListener('click', (e) => {
    e.preventDefault();
    alert('Settings fetching failed because the functionality is not yet implemented.');
});


loadWorkflows();
</script>

</body>
</html>
